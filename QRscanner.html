<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Barcode Scanner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        h1, h2 {
            color: #333;
            text-align: center;
        }
        #scanner-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        #interactive.viewport {
            width: 100%;
            height: 300px;
            position: relative;
            background-color: #000;
        }
        #interactive.viewport canvas, video {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        button {
            display: block;
            margin: 20px auto;
            padding: 12px 24px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #3367d6;
        }
        #result {
            margin-top: 20px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: none;
        }
        .company-info {
            margin-top: 10px;
        }
        .company-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .company-stance {
            margin-top: 5px;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            font-weight: bold;
        }
        .stance-avoid {
            background-color: #ffebee;
            color: #c62828;
        }
        .stance-neutral {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .loading {
            text-align: center;
            margin-top: 20px;
            display: none;
        }
        .company-description {
            margin-top: 10px;
            color: #555;
        }
        .barcode-list {
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .barcode-item {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .barcode-number {
            font-weight: bold;
            color: #333;
        }
        .tab-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .tab-button {
            margin: 0 10px;
            padding: 10px 20px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .tab-button.active {
            background-color: #4285f4;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #barcode-raw {
            margin-top: 10px;
            font-family: monospace;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Boycott Product Company Scanner</h1>
        
        <div class="tab-buttons">
            <button class="tab-button active" data-tab="scanner">Scanner</button>
            <button class="tab-button" data-tab="test-barcodes">Test Barcodes</button>
        </div>
        
        <div id="scanner-tab" class="tab-content active">
            <div id="scanner-container">
                <div id="interactive" class="viewport"></div>
            </div>
            
            <button id="start-button">Start Scanner</button>
            
            <div class="loading" id="loading">
                Scanning...
            </div>
            
            <div id="result">
                <div class="company-info">
                    <div class="company-name" id="company-name"></div>
                    <div class="company-stance" id="company-stance"></div>
                    <div class="company-description" id="company-description"></div>
                    <div id="barcode-raw"></div>
                </div>
            </div>
        </div>
        
        <div id="test-barcodes-tab" class="tab-content">
            <h2>Test Barcodes</h2>
            <p>Use these real barcodes to test the scanner. Either take a picture of these numbers or use products with these barcodes:</p>
            
            <div class="barcode-list">
                <div class="barcode-item">
                    <div class="barcode-number">049000042566</div>
                    <div>Coca-Cola Classic 12oz Can</div>
                </div>
                <div class="barcode-item">
                    <div class="barcode-number">7613034626844</div>
                    <div>Nestlé KitKat Chocolate Bar</div>
                </div>
                <div class="barcode-item">
                    <div class="barcode-number">013803135176</div>
                    <div>McDonald's Happy Meal Toy</div>
                </div>
                <div class="barcode-item">
                    <div class="barcode-number">190199247895</div>
                    <div>Apple iPhone Charger</div>
                </div>
                <div class="barcode-item">
                    <div class="barcode-number">659658796957</div>
                    <div>Nike Air Running Shoes</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Real barcode database (UPC/EAN codes) for major companies
const barcodeDatabase = {
    // Coca-Cola products
    "049000042566": {
        name: "Coca-Cola Company",
        product: "Coca-Cola Classic 12oz Can",
        stance: "avoid",
        description: "Global beverage corporation headquartered in Atlanta, Georgia. Known for soft drinks including Coca-Cola, Sprite, Fanta, and more."
    },
    "049000042535": {
        name: "Coca-Cola Company",
        product: "Diet Coke 12oz Can",
        stance: "avoid",
        description: "Global beverage corporation headquartered in Atlanta, Georgia. Known for soft drinks including Coca-Cola, Sprite, Fanta, and more."
    },
    
    // Nestlé products
    "7613034626844": {
        name: "Nestlé S.A.",
        product: "KitKat Chocolate Bar",
        stance: "avoid",
        description: "Swiss multinational food and drink processing corporation. Products include baby food, bottled water, breakfast cereals, coffee, confectionery, dairy products, and pet foods."
    },
    "7613038452826": {
        name: "Nestlé S.A.",
        product: "Nescafé Coffee",
        stance: "avoid",
        description: "Swiss multinational food and drink processing corporation. Products include baby food, bottled water, breakfast cereals, coffee, confectionery, dairy products, and pet foods."
    },
    
    // McDonald's items
    "013803135176": {
        name: "McDonald's Corporation",
        product: "Happy Meal Toy",
        stance: "avoid",
        description: "American fast food company, founded in 1940. One of the world's largest restaurant chains, serving approximately 69 million customers daily in over 100 countries."
    },
    
    // Apple products
    "190199247895": {
        name: "Apple Inc.",
        product: "iPhone Charger",
        stance: "avoid",
        description: "American multinational technology company that specializes in consumer electronics, software and online services. Known for iPhone, iPad, Mac computers, and various services."
    },
    "190198155795": {
        name: "Apple Inc.",
        product: "AirPods",
        stance: "avoid",
        description: "American multinational technology company that specializes in consumer electronics, software and online services. Known for iPhone, iPad, Mac computers, and various services."
    },
    
    // Nike products
    "659658796957": {
        name: "Nike, Inc.",
        product: "Air Running Shoes",
        stance: "avoid",
        description: "American multinational corporation engaged in the design, development, manufacturing, and worldwide marketing and sales of footwear, apparel, equipment, accessories, and services."
    },
    "659658854541": {
        name: "Nike, Inc.",
        product: "Sports T-Shirt",
        stance: "avoid",
        description: "American multinational corporation engaged in the design, development, manufacturing, and worldwide marketing and sales of footwear, apparel, equipment, accessories, and services."
    }
};

let scanning = false;
let isWebView = false;

// Detect if running in WebView
function detectWebView() {
    // Common WebView user agent indicators
    const ua = navigator.userAgent.toLowerCase();
    if (ua.indexOf('wv') > -1 || 
        ua.indexOf('android') > -1 && ua.indexOf('version/') > -1 ||
        window.AndroidInterface !== undefined || 
        window.webkit && window.webkit.messageHandlers) {
        console.log("Running in WebView environment");
        isWebView = true;
        return true;
    }
    return false;
}

// Initialize app when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM loaded, initializing app");
    detectWebView();
    addDiagnosticButton();
    addManualEntryOption();
    
    // Add WebView-specific message if detected
    if (isWebView) {
        addWebViewNotice();
    }
    
    checkSecureContext();
}, false);

// Start scanner button
document.getElementById('start-button').addEventListener('click', function() {
    if (scanning) {
        stopScanner();
        this.textContent = 'Start Scanner';
    } else {
        startScanner();
        this.textContent = 'Stop Scanner';
    }
});

// Tab switching
document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', function() {
        const tabId = this.getAttribute('data-tab');
        
        // Update button states
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        this.classList.add('active');
        
        // Update tab visibility
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        if (tabId === 'scanner') {
            document.getElementById('scanner-tab').classList.add('active');
        } else {
            document.getElementById('test-barcodes-tab').classList.add('active');
        }
        
        // Stop scanner when switching away from scanner tab
        if (tabId !== 'scanner' && scanning) {
            stopScanner();
            document.getElementById('start-button').textContent = 'Start Scanner';
        }
    });
});

// Device ready event handler - both for Cordova and browser
function onDeviceReady() {
    console.log("Device is ready");
    
    // Handle Cordova environment
    if (typeof cordova !== 'undefined') {
        requestCordovaPermissions();
    } 
    // Handle WebView that might not have Cordova
    else if (isWebView) {
        // Try to access any WebView Bridge that might be available
        tryWebViewBridge();
    }
}

// Try to find and use any available WebView JavaScript bridges
function tryWebViewBridge() {
    console.log("Attempting to access WebView bridges");
    
    // Try Android WebView interface if available
    if (window.AndroidInterface) {
        console.log("Found Android interface bridge");
        try {
            // Call a method that might be implemented in the WebView
            window.AndroidInterface.requestCameraPermission();
        } catch(e) {
            console.error("Error calling Android interface:", e);
        }
    }
    
    // Try iOS WebView interface if available
    if (window.webkit && window.webkit.messageHandlers) {
        console.log("Found iOS webkit message handlers");
        try {
            // Call a method that might be implemented in the WebView
            window.webkit.messageHandlers.requestCameraPermission.postMessage({});
        } catch(e) {
            console.error("Error calling iOS interface:", e);
        }
    }
}

// Request Cordova permissions
function requestCordovaPermissions() {
    if (cordova.plugins && cordova.plugins.permissions) {
        cordova.plugins.permissions.requestPermission(
            cordova.plugins.permissions.CAMERA, 
            function(status) {
                console.log("Permission status:", status);
                if (status.hasPermission) {
                    console.log("Camera permission granted");
                } else {
                    console.warn("Camera permission denied");
                    alert("Camera permission is required for barcode scanning");
                }
            }, 
            function(error) {
                console.error("Permission request error:", error);
            }
        );
    } else if (cordova.plugins && cordova.plugins.androidPermissions) {
        // Use androidPermissions plugin as fallback
        const permissions = cordova.plugins.androidPermissions;
        permissions.requestPermission(permissions.CAMERA, function(status) {
            if (status.hasPermission) {
                console.log("Camera permission granted via androidPermissions");
            } else {
                console.warn("Camera permission denied");
                alert("Camera permission is required for barcode scanning");
            }
        }, function(error) {
            console.error("Error requesting permission:", error);
        });
    }
}

// Listen for both Cordova deviceready and normal page load
document.addEventListener('deviceready', onDeviceReady, false);

// Improved startScanner function with better WebView handling
function startScanner() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('result').style.display = 'none';
    
    // Special handling for WebViews
    if (isWebView && typeof cordova === 'undefined') {
        console.log("WebView detected without Cordova, trying alternate approach");
        startWebViewScanner();
        return;
    }
    
    // Check for Cordova environment first
    if (typeof cordova !== 'undefined' && cordova.plugins) {
        console.log("Using Cordova environment");
        
        // Try BarcodeScanner plugin first if available
        if (cordova.plugins.barcodeScanner) {
            console.log("Using Cordova BarcodeScanner plugin");
            cordova.plugins.barcodeScanner.scan(
                function (result) {
                    if (!result.cancelled) {
                        console.log("Barcode scanned: " + result.text);
                        processBarcodeResult(result.text);
                    } else {
                        console.log("Scanning was cancelled");
                    }
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('start-button').textContent = 'Start Scanner';
                },
                function (error) {
                    console.error("Scanning failed: " + error);
                    alert("Failed to scan: " + error);
                    document.getElementById('loading').style.display = 'none';
                }
            );
            return;
        }
        // Fallback to camera plugin
        else if (cordova.plugins.camera) {
            console.log("Using Cordova camera plugin");
            cordova.plugins.camera.getPicture(
                function(imageData) {
                    console.log("Got image from camera");
                    alert("Camera access successful but barcode detection from images requires additional processing.");
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('start-button').textContent = 'Start Scanner';
                },
                function(error) {
                    console.error("Camera error: " + error);
                    alert("Unable to access camera: " + error);
                    document.getElementById('loading').style.display = 'none';
                },
                {
                    quality: 50,
                    destinationType: 0, // DATA_URL
                    sourceType: 1,      // CAMERA
                    encodingType: 0,    // JPEG
                    mediaType: 0,       // PICTURE
                    correctOrientation: true
                }
            );
            return;
        }
    }
    
    // Standard browser approach for camera access
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        console.log("Using standard browser media API");
        startWebScanner();
    } 
    // Legacy approach for older browsers
    else if (navigator.getUserMedia || navigator.webkitGetUserMedia || 
             navigator.mozGetUserMedia || navigator.msGetUserMedia) {
        console.log("Using legacy getUserMedia API");
        
        const getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia ||
                            navigator.mozGetUserMedia || navigator.msGetUserMedia;
        
        getUserMedia.call(navigator, 
            { video: { facingMode: "environment" } },
            function(stream) {
                console.log("Camera access successful via legacy API");
                startLegacyQuaggaScanner(stream);
            },
            function(err) {
                console.error("Legacy camera error:", err);
                alert("Unable to access camera. Please check permissions.");
                document.getElementById('loading').style.display = 'none';
            }
        );
    } 
    // Direct Quagga attempt as last resort
    else {
        console.log("No standard camera API detected, trying direct Quagga initialization");
        directQuaggaStart();
    }
}

// Special WebView scanner initialization
function startWebViewScanner() {
    console.log("Attempting WebView specific scanner startup");
    
    // First try to use any available WebView camera bridge
    if (window.AndroidInterface && window.AndroidInterface.startCamera) {
        try {
            window.AndroidInterface.startCamera();
            return;
        } catch(e) {
            console.error("Error calling AndroidInterface.startCamera:", e);
        }
    }
    
    // Fallback to standard getUserMedia with specific WebView configurations
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        console.log("Using getUserMedia in WebView");
        
        // Use minimal constraints for WebView
        navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: "environment",
                width: { ideal: 640 },
                height: { ideal: 480 }
            }
        })
        .then(function(stream) {
            console.log("Camera access successful in WebView");
            
            // Create a video element to display the camera feed first
            const videoElement = document.createElement('video');
            videoElement.id = 'camera-preview';
            videoElement.style.width = '100%';
            videoElement.style.height = 'auto';
            videoElement.autoplay = true;
            videoElement.playsInline = true; // Important for iOS
            
            const interactiveDiv = document.querySelector('#interactive');
            interactiveDiv.innerHTML = ''; // Clear any existing content
            interactiveDiv.appendChild(videoElement);
            
            // Connect the stream to the video element
            videoElement.srcObject = stream;
            videoElement.play().then(() => {
                console.log("Video playing in WebView");
                
                // Now initialize Quagga with this video element
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: videoElement
                    },
                    locator: {
                        patchSize: "medium",
                        halfSample: true
                    },
                    numOfWorkers: 1,
                    decoder: {
                        readers: ["ean_reader", "upc_reader"]
                    },
                    locate: true
                }, function(err) {
                    if (err) {
                        console.error("Quagga error in WebView:", err);
                        alert("Scanner failed to initialize in WebView. Please try the manual entry option.");
                        document.getElementById('loading').style.display = 'none';
                        return;
                    }
                    
                    scanning = true;
                    Quagga.start();
                    document.getElementById('loading').style.display = 'none';
                    
                    Quagga.onDetected(handleBarcodeResult);
                });
            }).catch(err => {
                console.error("Video play failed:", err);
                alert("Failed to start video stream in WebView. Please try manual entry.");
                document.getElementById('loading').style.display = 'none';
            });
        })
        .catch(function(err) {
            console.error("WebView camera access error:", err);
            alert("Unable to access camera in WebView. This may be due to permission issues. Please try manual entry.");
            document.getElementById('loading').style.display = 'none';
        });
    } else {
        console.log("No camera API available in this WebView");
        alert("This WebView doesn't support camera access. Please use the manual entry option.");
        document.getElementById('loading').style.display = 'none';
    }
}

// New standard browser approach
function startWebScanner() {
    navigator.mediaDevices.getUserMedia({ 
        video: { 
            facingMode: "environment",
            width: { ideal: 1280 },
            height: { ideal: 720 }
        } 
    })
    .then(function(stream) {
        console.log("Camera access successful");
        // Stop the test stream - we'll let Quagga handle it
        stream.getTracks().forEach(track => track.stop());
        
        // Now start Quagga
        startQuaggaScanner();
    })
    .catch(function(err) {
        console.error("Camera access error:", err);
        // Try one more time with minimal constraints
        navigator.mediaDevices.getUserMedia({ video: true })
        .then(function(stream) {
            console.log("Basic camera access successful");
            stream.getTracks().forEach(track => track.stop());
            startQuaggaScanner();
        })
        .catch(function(finalErr) {
            console.error("Final camera access error:", finalErr);
            alert("Unable to access camera. Please check your camera permissions.");
            document.getElementById('loading').style.display = 'none';
        });
    });
}

// Legacy approach for older browsers
function startLegacyQuaggaScanner(stream) {
    // We need to create video element and pass stream to Quagga
    const videoElement = document.createElement('video');
    document.querySelector('#interactive').appendChild(videoElement);
    
    // Attach stream to video element
    if (videoElement.srcObject !== undefined) {
        videoElement.srcObject = stream;
    } else {
        // For older browsers
        videoElement.src = window.URL.createObjectURL(stream);
    }
    videoElement.play();
    
    // Initialize Quagga with our video element
    Quagga.init({
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: videoElement
        },
        locator: {
            patchSize: "large",
            halfSample: true
        },
        numOfWorkers: 1,
        decoder: {
            readers: ["ean_reader", "upc_reader"]
        },
        locate: true
    }, function(err) {
        if (err) {
            console.error("Quagga initialization error:", err);
            alert("Scanner initialization failed. Please try again.");
            document.getElementById('loading').style.display = 'none';
            return;
        }
        
        scanning = true;
        Quagga.start();
        document.getElementById('loading').style.display = 'none';
        
        Quagga.onDetected(handleBarcodeResult);
    });
}

// Direct Quagga initialization as last resort
function directQuaggaStart() {
    Quagga.init({
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector('#interactive'),
            constraints: {
                facingMode: "environment"
            }
        },
        locator: {
            patchSize: "large"
        },
        numOfWorkers: 0,
        decoder: {
            readers: ["ean_reader", "upc_reader"]
        }
    }, function(err) {
        if (err) {
            console.error("Direct Quagga error:", err);
            alert("Your device may not support camera access or has denied permission.");
            document.getElementById('loading').style.display = 'none';
            return;
        }
        
        scanning = true;
        Quagga.start();
        document.getElementById('loading').style.display = 'none';
        
        Quagga.onDetected(handleBarcodeResult);
    });
}

function startQuaggaScanner() {
    // Try with progressive quality settings
    console.log("Starting Quagga with progressive settings");
    
    // Try with optimal settings first
    tryQuaggaWithSettings({
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector('#interactive'),
            constraints: {
                facingMode: "environment",
                width: {min: 640, ideal: 1280, max: 1920},
                height: {min: 480, ideal: 720, max: 1080},
            },
        },
        locator: {
            patchSize: "medium",
            halfSample: true
        },
        numOfWorkers: 2,
        decoder: {
            readers: ["ean_reader", "ean_8_reader", "upc_reader", "upc_e_reader"]
        },
        locate: true
    });
}

function tryQuaggaWithSettings(settings) {
    Quagga.init(settings, function(err) {
        if (err) {
            console.log("Error with settings:", err);
            
            // If settings don't work, try simplified settings
            if (settings.inputStream.constraints.width && settings.inputStream.constraints.width.ideal > 640) {
                console.log("Trying with simplified settings");
                tryQuaggaWithSettings({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: document.querySelector('#interactive'),
                        constraints: {
                            facingMode: "environment",
                            width: {min: 640, ideal: 640, max: 640},
                            height: {min: 480, ideal: 480, max: 480},
                        },
                    },
                    locator: {
                        patchSize: "large",
                        halfSample: true
                    },
                    numOfWorkers: 1,
                    decoder: {
                        readers: ["ean_reader", "upc_reader"]
                    },
                    locate: true
                });
            } else if (settings.numOfWorkers > 0) {
                // Try with minimal settings
                console.log("Trying with minimal settings");
                tryQuaggaWithSettings({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: document.querySelector('#interactive'),
                        constraints: {
                            facingMode: "environment"
                        }
                    },
                    locator: {
                        patchSize: "large"
                    },
                    numOfWorkers: 0,
                    decoder: {
                        readers: ["ean_reader"]
                    }
                });
            } else {
                // All attempts failed
                console.error("All scanner attempts failed");
                alert("Unable to start camera scanner. Please ensure camera permissions are granted and no other app is using the camera.");
                document.getElementById('loading').style.display = 'none';
            }
            return;
        }
        
        // If we get here, initialization was successful
        console.log("Quagga initialized successfully");
        scanning = true;
        Quagga.start();
        document.getElementById('loading').style.display = 'none';
        
        // Set up the detection callback
        Quagga.onDetected(handleBarcodeResult);
    });
}

// Unified handler for barcode detection results
function handleBarcodeResult(result) {
    if (result && result.codeResult && result.codeResult.code) {
        const barcode = result.codeResult.code;
        console.log("Barcode detected:", barcode);
        
        // Process the barcode
        processBarcodeResult(barcode);
        
        // Stop the scanner
        stopScanner();
        document.getElementById('start-button').textContent = 'Start Scanner';
    }
}

// Enhanced stopScanner function to clean up all resources
function stopScanner() {
    if (scanning) {
        try {
            Quagga.stop();
        } catch (e) {
            console.error("Error stopping Quagga:", e);
        }
        
        // Clean up any video streams that might be active
        const videoElements = document.querySelectorAll('video');
        videoElements.forEach(video => {
            if (video.srcObject) {
                const tracks = video.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                video.srcObject = null;
            }
        });
        
        scanning = false;
        document.getElementById('loading').style.display = 'none';
    }
}

function processBarcodeResult(barcode) {
    document.getElementById('result').style.display = 'block';
    document.getElementById('barcode-raw').textContent = "Barcode: " + barcode;
    
    // Check if the barcode matches a company in our database
    if (barcodeDatabase[barcode]) {
        const product = barcodeDatabase[barcode];
        
        document.getElementById('company-name').textContent = product.name + " - " + product.product;
        
        const stanceElement = document.getElementById('company-stance');
        stanceElement.textContent = product.stance === 'avoid' ? 'Recommended to Avoid' : 'Neutral';
        stanceElement.className = 'company-stance ' + (product.stance === 'avoid' ? 'stance-avoid' : 'stance-neutral');
        
        document.getElementById('company-description').textContent = product.description;
    } else {
        // Product not found in database
        document.getElementById('company-name').textContent = 'Unknown Product';
        document.getElementById('company-stance').textContent = '';
        document.getElementById('company-stance').className = 'company-stance';
        document.getElementById('company-description').textContent = 'This product barcode (' + barcode + ') is not in our database.';
    }
}

// Add a diagnostic button function
function addDiagnosticButton() {
    const container = document.querySelector('.container');
    
    // Create diagnostic button
    const diagButton = document.createElement('button');
    diagButton.textContent = 'Camera API Diagnosis';
    diagButton.style.backgroundColor = '#ff9800';
    diagButton.style.marginTop = '20px';
    
    // Add event listener
    diagButton.addEventListener('click', runDiagnostics);
    
    // Add to page
    container.appendChild(diagButton);
}

// Add WebView specific notice
function addWebViewNotice() {
    const container = document.querySelector('.container');
    
    const notice = document.createElement('div');
    notice.style.backgroundColor = '#e3f2fd';
    notice.style.padding = '10px';
    notice.style.borderRadius = '4px';
    notice.style.marginTop = '15px';
    notice.style.border = '1px solid #90caf9';
    
    notice.innerHTML = `<p><strong>WebView Environment Detected</strong></p>
                       <p>You're running this app in a WebView context. If the camera doesn't work, 
                       please use the manual barcode entry option below, or try opening the app in a regular browser.</p>`;
    
    // Insert at top of container
    container.insertBefore(notice, container.firstChild);
}

// Run diagnostics
function runDiagnostics() {
    let diagnosticResults = "CAMERA API DIAGNOSTICS\n";
    diagnosticResults += "--------------------\n\n";
    
    // Check if in WebView
    diagnosticResults += "WebView Detected: " + isWebView + "\n";
    
    // Check Cordova
    diagnosticResults += "Cordova Available: " + (typeof cordova !== 'undefined') + "\n";
    if (typeof cordova !== 'undefined') {
        diagnosticResults += "Cordova Camera Plugin: " + (cordova.plugins && cordova.plugins.camera ? "Available" : "Not Available") + "\n";
        diagnosticResults += "Cordova Barcode Scanner: " + (cordova.plugins && cordova.plugins.barcodeScanner ? "Available" : "Not Available") + "\n";
        diagnosticResults += "Cordova Permissions: " + (cordova.plugins && cordova.plugins.permissions ? "Available" : "Not Available") + "\n";
    }
    
    // Check Android WebView bridge
    diagnosticResults += "\nAndroid WebView Interface: " + (window.AndroidInterface !== undefined) + "\n";
    
    // Check iOS WebView bridge
    diagnosticResults += "iOS WebKit Handlers: " + (window.webkit && window.webkit.messageHandlers ? "Available" : "Not Available") + "\n";
    
    // Check getUserMedia support
    diagnosticResults += "\nModern getUserMedia: " + (navigator.mediaDevices && navigator.mediaDevices.getUserMedia ? "Supported" : "Not Supported") + "\n";
    
    // Check legacy getUserMedia
    const legacySupport = navigator.getUserMedia || navigator.webkitGetUserMedia || 
                          navigator.mozGetUserMedia || navigator.msGetUserMedia;
    diagnosticResults += "Legacy getUserMedia: " + (legacySupport ? "Supported" : "Not Supported") + "\n";
    
    // Check if running in mobile browser
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    diagnosticResults += "\nMobile Browser: " + isMobile + "\n";
    diagnosticResults += "User Agent: " + navigator.userAgent + "\n";
    
    // HTTPS check
    const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    diagnosticResults += "\nSecure Context (HTTPS/localhost): " + isSecure + "\n";
    diagnosticResults += "Current protocol: " + location.protocol + "\n";
    
    // Display results
    alert(diagnosticResults);
    console.log(diagnosticResults);
}

// Add manual entry option
function addManualEntryOption() {
    const scannerTab = document.getElementById('scanner-tab');
    const startButton = document.getElementById('start-button');
    
    // Create container for manual entry
    const manualEntryDiv = document.createElement('div');
    manualEntryDiv.style.marginTop = '20px';
    manualEntryDiv.style.textAlign = 'center';
    
    // Add text
    const orText = document.createElement('p');
    orText.textContent = 'Or enter barcode manually:';
    
    barcodeInput.style.display = 'block';
    barcodeInput.style.borderRadius = '4px';
    barcodeInput.style.border = '1px solid #ccc';
    
    // Create submit button
    const submitButton = document.createElement('button');
    submitButton.textContent = 'Check Barcode';
    submitButton.addEventListener('click', function() {
        const barcode = document.getElementById('manual-barcode').value.trim();
        if (barcode) {
            processBarcodeResult(barcode);
        } else {
            alert('Please enter a barcode number');
        }
    });
    
    // Add all elements
    manualEntryDiv.appendChild(orText);
    manualEntryDiv.appendChild(barcodeInput);
    manualEntryDiv.appendChild(submitButton);
    
    // Insert after start button
    startButton.parentNode.insertBefore(manualEntryDiv, startButton.nextSibling);
    
    // Add enter key support for the input field
    barcodeInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const barcode = this.value.trim();
            if (barcode) {
                processBarcodeResult(barcode);
            } else {
                alert('Please enter a barcode number');
            }
        }
    });
}

// Add this to your DOMContentLoaded event
function checkSecureContext() {
    if (window.isSecureContext === false) {
        console.warn("Not in secure context - camera access may be restricted");
        
        // Only show alert in browser context, not in WebView
        if (!isWebView) {
            alert("Camera access requires HTTPS or localhost! Current protocol: " + location.protocol + 
                "\n\nPlease access this page via HTTPS or localhost instead of an IP address.");
        }
        
        // Add a visible warning on the page
        const warning = document.createElement('div');
        warning.style.backgroundColor = '#ffcccc';
        warning.style.padding = '15px';
        warning.style.margin = '15px 0';
        warning.style.borderRadius = '5px';
        warning.innerHTML = '<strong>⚠️ Security Warning:</strong> Camera access requires HTTPS or localhost. ' +
                           'Current protocol: ' + location.protocol + '<br><br>' +
                           'Please access this app via HTTPS or use "localhost" instead of an IP address.';
        
        document.querySelector('.container').prepend(warning);
    }
}

// Function to request camera permissions directly
function requestCameraPermission() {
    if (navigator.permissions && navigator.permissions.query) {
        navigator.permissions.query({name: 'camera'}).then(function(permissionStatus) {
            console.log("Camera permission status:", permissionStatus.state);
            
            // Listen for changes to permission state
            permissionStatus.onchange = function() {
                console.log("Camera permission state changed to:", this.state);
            };
            
            if (permissionStatus.state === 'prompt') {
                // We need to ask for permission, trigger getUserMedia to show the prompt
                navigator.mediaDevices.getUserMedia({ video: true })
                .then(function(stream) {
                    console.log("Camera permission granted");
                    // Stop the stream right away, we just needed the permission
                    stream.getTracks().forEach(track => track.stop());
                })
                .catch(function(err) {
                    console.error("Failed to get camera permission:", err);
                });
            }
        }).catch(function(error) {
            console.error("Error checking permission:", error);
        });
    } else if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        // Fallback for browsers that don't support permissions API
        navigator.mediaDevices.getUserMedia({ video: true })
        .then(function(stream) {
            console.log("Camera permission granted (fallback)");
            // Stop the stream right away, we just needed the permission
            stream.getTracks().forEach(track => track.stop());
        })
        .catch(function(err) {
            console.error("Failed to get camera permission (fallback):", err);
        });
    }
}

// For direct camera access in WebView via custom Android bridge
function setupWebViewBridge() {
    // Create a global function that Android WebView can call to process barcode results
    window.processWebViewBarcode = function(barcode) {
        console.log("Received barcode from WebView bridge:", barcode);
        if (barcode && typeof barcode === 'string') {
            processBarcodeResult(barcode);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('start-button').textContent = 'Start Scanner';
        }
    };
    
    // Add a direct camera button if we detect WebView environment
    if (isWebView) {
        const scannerTab = document.getElementById('scanner-tab');
        const startButton = document.getElementById('start-button');
        
        // Create new button specifically for Android native camera
        const nativeCameraButton = document.createElement('button');
        nativeCameraButton.textContent = 'Use Native Camera';
        nativeCameraButton.style.backgroundColor = '#4caf50';
        nativeCameraButton.style.marginTop = '10px';
        
        // Add event listener to call Android method
        nativeCameraButton.addEventListener('click', function() {
            if (window.AndroidInterface && window.AndroidInterface.launchBarcodeScanner) {
                // Call the Android method
                window.AndroidInterface.launchBarcodeScanner();
                document.getElementById('loading').style.display = 'block';
            } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.launchBarcodeScanner) {
                // Call the iOS method
                window.webkit.messageHandlers.launchBarcodeScanner.postMessage({});
                document.getElementById('loading').style.display = 'block';
            } else {
                alert("Native camera bridge not available in this WebView");
            }
        });
        
        // Insert before the start button
        startButton.parentNode.insertBefore(nativeCameraButton, startButton);
    }
}

// Call setupWebViewBridge when page loads
document.addEventListener('DOMContentLoaded', function() {
    setupWebViewBridge();
}, false);

// Add a function to test specific barcodes when clicked
function makeTestBarcodesClickable() {
    const barcodeItems = document.querySelectorAll('.barcode-item');
    
    barcodeItems.forEach(item => {
        const barcodeNumber = item.querySelector('.barcode-number');
        
        if (barcodeNumber) {
            barcodeNumber.style.cursor = 'pointer';
            barcodeNumber.style.color = '#4285f4';
            barcodeNumber.style.textDecoration = 'underline';
            
            barcodeNumber.addEventListener('click', function() {
                const barcode = this.textContent.trim();
                
                // Switch to scanner tab first
                document.querySelector('.tab-button[data-tab="scanner"]').click();
                
                // Process the barcode
                processBarcodeResult(barcode);
            });
        }
    });
}

// Call on page load
document.addEventListener('DOMContentLoaded', function() {
    makeTestBarcodesClickable();
}, false);

// Check for orientation changes which might affect camera
window.addEventListener('orientationchange', function() {
    console.log("Orientation changed");
    
    if (scanning) {
        // Restart scanner with short delay to allow orientation to complete
        stopScanner();
        setTimeout(function() {
            startScanner();
        }, 500);
    }
});

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
    console.log("Initializing application");
    detectWebView();
    addDiagnosticButton();
    addManualEntryOption();
    makeTestBarcodesClickable();
    
    if (isWebView) {
        addWebViewNotice();
        setupWebViewBridge();
    }
    
    checkSecureContext();
    
    // Request camera permission early
    setTimeout(requestCameraPermission, 1000);
}, false);
    </script>
</body>
</html>
